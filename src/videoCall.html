<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MS Teams Clone</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://www.gstatic.com/firebasejs/8.6.7/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
     <script src="https://www.gstatic.com/firebasejs/8.6.7/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.7/firebase-firestore.js"></script>
    <script crossorigin src="https://unpkg.com/@daily-co/daily-js"></script>
    <script src="./utils.js"></script>
    <script>
    var firebaseConfig = {
        apiKey: "AIzaSyAoThvyDnMKikCSZTzd00zp0_03lekKgGs",
        authDomain: "ms-teams-clone-3687d.firebaseapp.com",
        projectId: "ms-teams-clone-3687d",
        storageBucket: "ms-teams-clone-3687d.appspot.com",
        messagingSenderId: "35666250286",
        appId: "1:35666250286:web:b24086e604e7338629adbf",
        measurementId: "G-0DKCPEVW7W"
    };
    firebase.initializeApp(firebaseConfig);
    listenAuthChange();
</script>
</head>

<body style="overflow: hidden;">
    <div>
        <div class="side-nav">
            <div class="top">
            </div>
            <div class="mid">
            <a>
                <i class="fa fa-bell-o"></i>
            </a>
            <a href="./messaging.html">
                <i class="fa fa-commenting-o"></i>
            </a>
            <a href="./contacts.html">
                <i class="fa fa-phone"></i>
            </a>
            <a href="/index.html">
                <i class="fa fa-history"></i>
            </a>
            </div>
            <div class="bottom">
                <a href="#" onclick="logout()">
                    <i class="fa fa-sign-out"></i>
                </a>
            </div>
        </div>


        <div class="main-window">
            <nav class="main-nav nav">
                <ul>
                    <h1>Meeting App</h1>
                    <li class="right-align">
                        <div class="avatar">
                            AJ
                        </div>
                    </li>
                </ul>
            </nav>
            <div class="dropdown">
                <button class="right-align" onclick="toggleVisibility('featuresDropdown', 'block')"><i
                        class="fa fa-bars"></i></button>
                <ul id="featuresDropdown">
                    <li onclick="toggleVisibility('addParticipantsModal', 'block');">Add Participants</li>
                    <li onclick="showParticipantsModal()">Show Participants</li>
                    <li>Change Background</li>
                    <li>Whiteboard</li>
                    <li>Mute All</li>
                    <li>Chat</li>
                    <li onclick="addShareScreen()">Present Screen</li>
                    <li>Full Screen</li>
                </ul>
            </div>
            <div id="videos">
                <div class="video">
                    <video id="localVideo" autoplay draggable="true" muted="true"></video>
                    <div class="sub-controls">
                        <i class="fa fa-microphone"></i>
                        <i class="fa fa-smile-o"></i>
                    </div>
                    <div class="name">

                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="addParticipantsModal" class="modal">
        <div class="modalBox border-radius">
            <h1>Add Participants <button class="right-align btn-danger" onclick="toggleVisibility('addParticipantsModal', 'block');"><i
                class="fa fa-close"></i></button></h1>
            <div class="content">
                <div id="addParticipantsList">

                </div>
            </div>
        </div>
    </div>
    <div id="showParticipantsModal" class="modal">
        <div class="modalBox border-radius">
            <h1>Participants <button class="right-align btn-danger" onclick="toggleVisibility('showParticipantsModal', 'block');"><i
                class="fa fa-close"></i></button></h1>
            <div class="content">
                <div id="participantsList">

                </div>
            </div>
        </div>
    </div>
    <div class="video-controls">
        <div class="dropdown">
            <button onclick="toggleVisibility('reactions','block')"><i class="fa fa-smile-o"></i></button>
            <div id="reactions">
                <button onclick="toggleReaction('fa fa-smile-o')"><i class="fa fa-smile-o"></i></button>
                <button onclick="toggleReaction('fa fa-frown-o')"><i class="fa fa-frown-o"></i></button>
                <button onclick="toggleReaction('fa fa-hand-paper-o')"><i class="fa fa-hand-paper-o"></i></button>
                <button onclick="toggleReaction('fa fa-thumbs-o-up')"><i class="fa fa-thumbs-o-up"></i></button>
                <button onclick="toggleReaction('fa fa-thumbs-o-down')"><i class="fa fa-thumbs-o-down"></i></button>
            </div>
        </div>
        <button onclick="showChat()"><i class="fa fa-comments"></i></button>
    </div>
    <div id="loading">
        <div id="loader"></div>
    </div>
    <div id="alert" class="alert alert-danger">
        <span>{msg}</span>
        <span><i class="fa fa-check-circle"></i></span>
    </div>
    <div id="blocker"></div>
    <div id="sideWindow">

    </div>
    <script>
        let roomID = window.location.search.substr(6, window.location.search.length - 1);
        function createFrameAndJoinRoom() {
        window.callFrame = window.DailyIframe.createFrame({
      iframeStyle: {
        position: 'fixed',
        border: '1px solid black',
        width: 'calc(100vw - 2.4rem)',
        height: 'calc(100vh - 150px)',
        left: '2.6rem',
        top: '80px'
      },
      showLeaveButton: true,
      showFullscreenButton: true,
      userName:localStorage.getItem('name')
    });
    callFrame.setShowNamesMode('always')
        callFrame.join({ url: 'https://ms-teams-clone.daily.co/'+roomID });
        
        console.log(callFrame.participants())
        }
    </script>
    <!-- <script src="videoCall.js"></script> -->
    <script src="./calls_videoCall.js"></script>
    <script>
        let contacts=[];
        let nickNames={};
        let participants=[];
        nickNames[localStorage.getItem('uid')]=localStorage.getItem('name')
        document.getElementsByClassName('video')[0].getElementsByClassName('name')[0].innerText = localStorage.getItem('name');
        showAddParticipants('addParticipantsList');
        let user = {
            "id": localStorage.getItem('uid'),
            "name": localStorage.getItem('name'),
            "email": localStorage.getItem('email'),
            "screen": false
        };

        function showParticipantsModal() {
            updateParticipants(participants);
            toggleVisibility('showParticipantsModal', 'block');
        }
        function loadChat(id) {
            startLoading();
            fetchContacts().then((tempContacts)=>{
                let date=new Date();
                contacts=tempContacts;
                console.log(contacts)
                contacts.forEach((contact)=>nickNames[contact["uid"]]=contact["name"])
                usersDB.collection("chats").orderBy('time').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" && change.doc.id!=="details") {
                        const msg={...change.doc.data(), time:change.doc.data().time.toDate()};
                        document.getElementById('chats').insertAdjacentHTML('beforeend',createMsg(msg));
                        if(msg.time>date && msg.from!=localStorage.getItem('uid') && !document.getElementById('sideWindow').classList.contains('left-slide')){
                            showAlert("success", `${nickNames[msg.from]}<br/>${msg.msg}`,"")
                        }
                    }
                });
                stopLoading();
                scrollDown("chats");
            })
            });
            const msgs = [];
            const db = firebase.firestore();
            usersDB = db.collection('rooms').doc(id);
            document.getElementById('sideWindow').innerHTML = `<h3>${localStorage.getItem('roomName')}</h3>
            <div id="chats" class="chats">
                 
            </div>
            <form id="sendMsg" style="display:flex;  margin-top: 10px !important;">
                <textarea name="msg" class="msgInput"></textarea>
                <button type="submit" style="margin:0"><i class="fa fa-send"></i></button>
            </form>`;
            document.getElementById('sendMsg').onsubmit=(e)=>sendMsg(e);
            document.getElementsByClassName('msgInput')[0].onkeypress=((e)=>{
                if(e.which == 13 && !e.shiftKey){
                    e.preventDefault();
                    document.getElementById('sendMsg').dispatchEvent(new SubmitEvent("submit"));
                }
            })
            usersDB.get().then((doc) => {
                if (doc.exists) {
                    console.log(doc.data().name)
                    localStorage.setItem('roomName', doc.data().name);
                }
            })
            usersDB.collection("participants").onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        participants.push(change.doc.data());
                        if(change.doc.data()['id']==localStorage.getItem('uid'))
                        createFrameAndJoinRoom();
                    }
                });
            })
        }
        function sendMsg(e){
            e.preventDefault();
            const msg={from:localStorage.getItem('uid'), msg:e.target["msg"].value, time:new Date()};
            const db = firebase.firestore();
            usersDB = db.collection('rooms').doc(roomID);
            usersDB.collection('chats').add(msg)
            /* document.getElementById('chats').insertAdjacentHTML('beforeend',createMsg(msg)); */
            e.target.reset();
        }
        function createMsg(msg) {
            return `<div class="message ${msg.from === localStorage.getItem('uid') ? 'local' : 'remote'}-message">
                    <div class="name">
                        ${nickNames[msg.from]===undefined ? msg.from :nickNames[msg.from]}
                    </div>
                    <div class="msg">
                    ${msg.msg}
                    </div>
                </div>`
        }
        loadChat(roomID)
        function showChat(){
            let element=document.getElementById('sideWindow').classList.toggle('left-slide')
        }
    </script>

</body>

</html>